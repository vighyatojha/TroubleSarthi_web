<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trouble Sarthi - Login & Signup</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @font-face {
            font-family: 'SAMAN___';
            src: url('font/SAMAN___.TTF');
            font-display: swap;
        }

        /* ════ PAGE LOADER ════ */
        #pageLoader {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        #pageLoader .ld-logo {
            font-family: 'SAMAN___', sans-serif;
            font-size: 2.4rem;
            color: #fff;
            letter-spacing: 1px;
        }
        #pageLoader .ld-spin {
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #appContent { display: none; }

        .logo-title {
            text-align: center;
            font-size: clamp(1.8rem, 4vw, 2.2rem);
            font-weight: 700;
            font-family: "SAMAN___", sans-serif;
            color: #2d5a3d;
            margin-bottom: 0.3rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
            padding: 1rem;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><defs><pattern id="g" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/></pattern></defs><rect width="100%25" height="100%25" fill="url(%23g)"/></svg>');
            opacity: 0.3;
        }

        /* ── FIXED WIDTH CARD ── */
        .auth-container {
            background: rgba(255,255,255,0.97);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            width: 960px;          /* fixed width */
            max-width: 95vw;       /* shrinks on small screens */
            min-height: 580px;
            position: relative;
            z-index: 2;
            display: flex;
            overflow: hidden;
            transition: box-shadow 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        .auth-container:hover { box-shadow: 0 30px 80px rgba(0,0,0,0.2); }

        /* ── LEFT SIDE: fixed width ── */
        .animation-side {
            width: 400px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 2.5rem; color: #fff;
        }
        .floating-shapes { position: absolute; inset: 0; overflow: hidden; }
        .shape { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.1); animation: float 6s ease-in-out infinite; }
        .shape:nth-child(1) { width:60px;height:60px;top:20%;left:20%;animation-delay:0s; }
        .shape:nth-child(2) { width:40px;height:40px;top:60%;left:80%;animation-delay:2s; }
        .shape:nth-child(3) { width:80px;height:80px;top:40%;left:10%;animation-delay:4s; }
        .shape:nth-child(4) { width:30px;height:30px;top:80%;left:70%;animation-delay:1s; }
        .shape:nth-child(5) { width:90px;height:90px;top:10%;left:70%;animation-delay:3s; }
        @keyframes float { 0%,100% { transform:translateY(0) scale(1); } 50% { transform:translateY(-15px) scale(1.05); } }

        .welcome-content { position: relative; z-index: 2; text-align: center; }
        .welcome-title {
            font-size: 2.2rem; font-weight: 700; margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #fff, rgba(255,255,255,0.8));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .brand-name { font-size: 1.8rem; font-weight: 800; margin-bottom: 0.5rem; color: #fff; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-bottom: 2rem; font-weight: 300; }
        .welcome-features { list-style: none; text-align: left; }
        .welcome-features li {
            padding: 0.5rem 0;
            display: flex; align-items: center; gap: 0.75rem;
            opacity: 0.9; font-size: 0.95rem;
        }
        .welcome-features li::before {
            content: '✓';
            background: rgba(255,255,255,0.2);
            border-radius: 50%; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.8rem; flex-shrink: 0;
        }

        /* ── RIGHT SIDE: fills remaining space ── */
        .form-side {
            flex: 1;
            padding: 2.5rem 3rem;
            display: flex; flex-direction: column; justify-content: center;
            overflow-y: auto; max-height: 95vh;
        }
        .logo-subtitle { text-align: center; color: #666; margin-bottom: 1.5rem; font-size: 0.9rem; }

        .auth-tabs { display: flex; margin-bottom: 1.5rem; background: #f8f9fa; border-radius: 10px; padding: 0.3rem; gap: 0.3rem; }
        .tab-btn { flex: 1; padding: 0.8rem 1rem; border: none; border-radius: 8px; background: transparent; color: #666; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); font-size: 0.9rem; font-family: inherit; }
        .tab-btn.active { background: linear-gradient(45deg, #7cb342, #8bc34a); color: #fff; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(123,179,66,0.3); }

        .form-container { min-height: 350px; }
        .auth-form { display: none; animation: fadeInUp 0.5s cubic-bezier(0.4,0,0.2,1); }
        .auth-form.active { display: block; }

        .form-group { margin-bottom: 1.2rem; position: relative; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #2d5a3d; font-weight: 600; font-size: 0.85rem; }
        .form-input { width: 100%; padding: 0.85rem 1rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 0.95rem; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); background: #fff; font-family: inherit; }
        .form-input:focus { outline: none; border-color: #7cb342; box-shadow: 0 0 0 3px rgba(123,179,66,0.1); transform: translateY(-1px); }
        .form-input:hover { border-color: #7cb342; }

        .password-group { position: relative; }
        .password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; font-size: 1rem; padding: 0.4rem; transition: color 0.3s ease; border-radius: 50%; z-index: 3; }
        .password-toggle:hover { color: #7cb342; background: rgba(123,179,66,0.1); }
        .password-group .form-input { padding-right: 3rem; }

        .password-strength { margin-top: 0.5rem; display: none; }
        .password-strength.show { display: block; }
        .strength-bar { height: 4px; border-radius: 2px; background: #e9ecef; overflow: hidden; margin-bottom: 0.5rem; }
        .strength-fill { height: 100%; width: 0%; transition: all 0.3s ease; border-radius: 2px; }
        .strength-fill.weak   { width:25%; background:#dc3545; }
        .strength-fill.fair   { width:50%; background:#fd7e14; }
        .strength-fill.good   { width:75%; background:#ffc107; }
        .strength-fill.strong { width:100%; background:#28a745; }
        .strength-text { font-size: 0.8rem; font-weight: 600; }
        .strength-text.weak   { color:#dc3545; }
        .strength-text.fair   { color:#fd7e14; }
        .strength-text.good   { color:#ffc107; }
        .strength-text.strong { color:#28a745; }

        .password-requirements { margin-top: 0.5rem; font-size: 0.75rem; display: none; }
        .password-requirements.show { display: block; }
        .requirement { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.2rem; color: #666; transition: all 0.3s ease; }
        .requirement.valid { color: #28a745; }
        .requirement-icon { width:12px;height:12px;border-radius:50%;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:8px;transition:all 0.3s ease;flex-shrink:0; }
        .requirement.valid .requirement-icon { background:#28a745;border-color:#28a745;color:#fff; }

        .password-match { position:absolute;right:50px;top:50%;transform:translateY(-50%);width:20px;height:20px;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:12px;z-index:2; }
        .password-match.show { display: flex; }
        .password-match.valid   { background:#28a745;color:#fff; }
        .password-match.invalid { background:#dc3545;color:#fff; }

        .form-options { display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;font-size:0.85rem;flex-wrap:wrap;gap:0.5rem; }
        .remember-me { display:flex;align-items:center;gap:0.5rem;cursor:pointer; }
        .remember-me input[type="checkbox"] { accent-color:#7cb342;width:16px;height:16px;cursor:pointer; }
        .forgot-password { color:#7cb342;text-decoration:none;font-weight:600;transition:all 0.3s ease; }
        .forgot-password:hover { color:#2d5a3d;text-decoration:underline; }

        .submit-btn { width:100%;padding:1rem;background:linear-gradient(45deg,#7cb342,#8bc34a);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);margin-bottom:1.2rem;font-family:inherit; }
        .submit-btn:hover:not(:disabled) { transform:translateY(-2px);box-shadow:0 10px 30px rgba(123,179,66,0.4); }
        .submit-btn:active { transform:translateY(0); }
        .submit-btn:disabled { background:#ccc;cursor:not-allowed;transform:none;box-shadow:none; }

        .divider { text-align:center;margin:1.2rem 0;position:relative;color:#666;font-size:0.85rem;display:flex;align-items:center; }
        .divider::before, .divider::after { content:'';flex:1;height:1px;background:#e9ecef; }
        .divider::before { margin-right:1rem; }
        .divider::after  { margin-left:1rem; }

        .social-login { display:flex;gap:0.8rem;margin-bottom:0.8rem; }
        .social-btn { flex:1;padding:0.8rem 1.2rem;border:2px solid #e9ecef;border-radius:10px;background:#fff;color:#333;text-decoration:none;text-align:center;font-weight:600;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);display:flex;align-items:center;justify-content:center;gap:0.6rem;font-size:0.9rem;cursor:pointer;font-family:inherit; }
        .social-btn:hover { transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.1); }
        .google-btn:hover   { border-color:#db4437;color:#db4437; }
        .facebook-btn:hover { border-color:#3b5998;color:#3b5998; }
        .social-btn .fa-google   { color:#db4437;font-size:1.1rem; }
        .social-btn .fa-facebook { color:#3b5998;font-size:1.1rem; }

        .switch-link { text-align:center;font-size:0.85rem;color:#666;margin-top:1rem; }
        .switch-link a { color:#7cb342;text-decoration:none;font-weight:600; }
        .switch-link a:hover { color:#2d5a3d;text-decoration:underline; }

        .terms-group { display:flex;align-items:flex-start;gap:0.5rem;font-size:0.85rem;color:#666; }
        .terms-group input { accent-color:#7cb342;width:16px;height:16px;margin-top:2px;flex-shrink:0;cursor:pointer; }
        .terms-group a { color:#7cb342;text-decoration:none;font-weight:600; }
        .terms-group a:hover { color:#2d5a3d;text-decoration:underline; }

        .back-home {
            position: fixed; top: 1.5rem; left: 1.5rem;
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border: 2px solid rgba(123,179,66,0.3); border-radius: 40px;
            padding: 0.7rem 1.4rem; color: #2d5a3d; text-decoration: none;
            font-weight: 600; transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.85rem; z-index: 10;
        }
        .back-home:hover { background:#2d5a3d;color:#fff;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2); }

        #msgArea { margin-bottom: 0.5rem; }
        .php-message { padding:10px 16px;margin:8px 0;border-radius:10px;font-weight:600;text-align:center;animation:slideDown 0.3s ease-out;font-size:0.85rem;transition:opacity 0.3s ease-out; }
        .php-success { background:#d4edda;color:#155724;border:2px solid #c3e6cb; }
        .php-error   { background:#f8d7da;color:#721c24;border:2px solid #f5c6cb; }
        .php-message.hide { opacity:0;transform:translateY(-10px); }

        @keyframes fadeInUp  { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideDown { from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }

        /* ── RESPONSIVE ── */
        @media (max-width: 768px) {
            body { padding:0.5rem; align-items:flex-start; padding-top:4.5rem; }
            .auth-container { flex-direction:column; min-height:auto; width:100%; border-radius:16px; }
            .animation-side { width:100%; min-height:180px; padding:1.5rem; }
            .form-side { padding:1.5rem; max-height:none; overflow-y:visible; }
            .welcome-features { display:grid; grid-template-columns:1fr 1fr; gap:0.3rem; }
            .social-login { flex-direction:column; }
            .back-home { top:0.8rem; left:0.8rem; padding:0.6rem 1rem; }
        }
        @media (max-width: 480px) {
            body { padding:0.3rem; padding-top:3.5rem; }
            .auth-container { border-radius:12px; }
            .animation-side { min-height:150px; }
            .form-side { padding:1.2rem; }
            .tab-btn { padding:0.7rem 0.8rem; }
            .welcome-features { grid-template-columns:1fr; }
            .back-home { top:0.5rem; left:0.5rem; padding:0.5rem 0.8rem; font-size:0.75rem; }
        }
    </style>
</head>
<body>

<div id="pageLoader">
    <div class="ld-logo">Trouble Sarthi</div>
    <div class="ld-spin"></div>
</div>

<div id="appContent">
    <a href="index.html" class="back-home"><i class="fas fa-arrow-left"></i> Back to Home</a>

    <div class="auth-container">
        <!-- LEFT: branding panel -->
        <div class="animation-side">
            <div class="floating-shapes">
                <div class="shape"></div><div class="shape"></div><div class="shape"></div>
                <div class="shape"></div><div class="shape"></div>
            </div>
            <div class="welcome-content">
                <h1 class="welcome-title">Welcome to</h1>
                <h2 class="brand-name">Trouble Sarthi</h2>
                <p class="welcome-subtitle">Your Local Helper Network</p>
                <ul class="welcome-features">
                    <li>Connect with local helpers</li>
                    <li>Quick problem solving</li>
                    <li>Trusted community</li>
                    <li>Available 24/7</li>
                </ul>
            </div>
        </div>

        <!-- RIGHT: form panel -->
        <div class="form-side">
            <div class="logo-title">Trouble Sarthi</div>
            <p class="logo-subtitle">Your trusted local helper network</p>

            <div id="msgArea"></div>

            <div class="auth-tabs">
                <button class="tab-btn active" id="loginTab"  onclick="switchTab('login')">Login</button>
                <button class="tab-btn"        id="signupTab" onclick="switchTab('signup')">Sign Up</button>
            </div>

            <div class="form-container">

                <!-- LOGIN FORM -->
                <div class="auth-form active" id="loginForm">
                    <div class="form-group">
                        <label for="l_username">Username or Email</label>
                        <input type="text" id="l_username" class="form-input" placeholder="Enter your username or email" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="l_password">Password</label>
                        <div class="password-group">
                            <input type="password" id="l_password" class="form-input" placeholder="Enter your password" autocomplete="current-password">
                            <button type="button" class="password-toggle" onclick="togglePassword('l_password',this)"><i class="fa-solid fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="form-options">
                        <label class="remember-me">
                            <input type="checkbox" id="rememberMe"> Remember me
                        </label>
                        <a href="#" class="forgot-password" onclick="handleForgot();return false;">Forgot Password?</a>
                    </div>
                    <button class="submit-btn" id="loginBtn" onclick="doLogin()">Login</button>
                    <div class="divider"><span>Or continue with</span></div>
                    <div class="social-login">
                        <button class="social-btn google-btn"   onclick="doGoogle()"><i class="fa-brands fa-google"></i> Continue with Google</button>
                        <button class="social-btn facebook-btn" onclick="doFacebook()"><i class="fa-brands fa-facebook"></i> Continue with Facebook</button>
                    </div>
                    <p class="switch-link">Don't have an account? <a href="#" onclick="switchTab('signup');return false;">Sign up</a></p>
                </div>

                <!-- SIGNUP FORM -->
                <div class="auth-form" id="signupForm">
                    <div class="form-group">
                        <label for="s_name">Full Name</label>
                        <input type="text" id="s_name" class="form-input" placeholder="Enter your full name" autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="s_username">Username</label>
                        <input type="text" id="s_username" class="form-input" placeholder="Choose a username" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="s_email">Email Address</label>
                        <input type="email" id="s_email" class="form-input" placeholder="Enter your email" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="s_phone">Phone Number</label>
                        <input type="tel" id="s_phone" class="form-input" placeholder="Enter 10-digit phone number" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label for="s_password">Password</label>
                        <div class="password-group">
                            <input type="password" id="s_password" class="form-input" placeholder="Create a strong password" autocomplete="new-password" oninput="onPasswordInput(this.value)">
                            <button type="button" class="password-toggle" onclick="togglePassword('s_password',this)"><i class="fa-solid fa-eye"></i></button>
                        </div>
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
                            <div class="strength-text" id="strengthText">Password strength</div>
                        </div>
                        <div class="password-requirements" id="passwordRequirements">
                            <div class="requirement" id="lengthReq"><span class="requirement-icon">✗</span> At least 8 characters</div>
                            <div class="requirement" id="uppercaseReq"><span class="requirement-icon">✗</span> One uppercase letter</div>
                            <div class="requirement" id="lowercaseReq"><span class="requirement-icon">✗</span> One lowercase letter</div>
                            <div class="requirement" id="numberReq"><span class="requirement-icon">✗</span> One number</div>
                            <div class="requirement" id="specialReq"><span class="requirement-icon">✗</span> One special character (@$!%*?&)</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="s_confirm">Confirm Password</label>
                        <div class="password-group">
                            <input type="password" id="s_confirm" class="form-input" placeholder="Confirm your password" autocomplete="new-password" oninput="checkPasswordMatch()">
                            <div class="password-match" id="passwordMatch"></div>
                            <button type="button" class="password-toggle" onclick="togglePassword('s_confirm',this)"><i class="fa-solid fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="form-group terms-group">
                        <input type="checkbox" id="termsCheck" onchange="updateSignupBtn()">
                        <label for="termsCheck">I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></label>
                    </div>
                    <button class="submit-btn" id="signupBtn" onclick="doSignup()" disabled>Create Account</button>
                    <div class="divider"><span>Or sign up with</span></div>
                    <div class="social-login">
                        <button class="social-btn google-btn"   onclick="doGoogle()"><i class="fa-brands fa-google"></i> Continue with Google</button>
                        <button class="social-btn facebook-btn" onclick="doFacebook()"><i class="fa-brands fa-facebook"></i> Continue with Facebook</button>
                    </div>
                    <p class="switch-link">Already have an account? <a href="#" onclick="switchTab('login');return false;">Login</a></p>
                </div>

            </div>
        </div>
    </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, createUserWithEmailAndPassword,
    GoogleAuthProvider, FacebookAuthProvider, signInWithPopup,
    sendPasswordResetEmail,
    browserLocalPersistence, browserSessionPersistence, setPersistence,
    updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
    getFirestore, doc, getDoc, setDoc, getDocs,
    collection, query, where, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey:            "AIzaSyBTyz4ZSHFKtg9Eq-eZ2rD5fPcapNRyQyo",
    authDomain:        "trouble-sarthi.firebaseapp.com",
    projectId:         "trouble-sarthi",
    storageBucket:     "trouble-sarthi.firebasestorage.app",
    messagingSenderId: "241665118590",
    appId:             "1:241665118590:web:e705c3ca12324b8c25632f"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

onAuthStateChanged(auth, async (user) => {
    if (user) {
        try {
            const adminSnap = await getDoc(doc(db, 'admins', user.uid));
            if (adminSnap.exists()) { window.location.replace('admin.html'); return; }
        } catch (e) {}
        window.location.replace('dashboard.html');
        return;
    }
    document.getElementById('pageLoader').style.display = 'none';
    document.getElementById('appContent').style.display = 'block';
    if (new URLSearchParams(location.search).get('tab') === 'signup') switchTab('signup');
});

const RL = {
    key: 'ts_login_rl',
    get()  { try { return JSON.parse(sessionStorage.getItem(this.key)||'{}'); } catch { return {}; } },
    set(d) { sessionStorage.setItem(this.key, JSON.stringify(d)); },
    reset(){ sessionStorage.removeItem(this.key); },
    locked(){
        const d = this.get();
        if (d.at && Date.now()-d.at < 900000) return true;
        if (d.at) this.reset();
        return false;
    },
    fail(){
        const d = this.get();
        d.n = (d.n||0)+1;
        if (d.n >= 5) d.at = Date.now();
        this.set(d); return d.n;
    }
};
let _cd = null;
function startCountdown(){
    const d = RL.get(); if (!d.at) return;
    const btn = document.getElementById('loginBtn');
    clearInterval(_cd);
    _cd = setInterval(()=>{
        const rem = 900000-(Date.now()-d.at);
        if (rem<=0){ clearInterval(_cd); btn.disabled=false; btn.textContent='Login'; RL.reset(); return; }
        const m = String(Math.floor(rem/60000)).padStart(2,'0');
        const s = String(Math.floor((rem%60000)/1000)).padStart(2,'0');
        btn.disabled=true; btn.textContent=`Try again in ${m}:${s}`;
    }, 1000);
}
if (RL.locked()) startCountdown();

window.doLogin = async () => {
    if (RL.locked()) { startCountdown(); return; }
    const input = document.getElementById('l_username').value.trim();
    const pw    = document.getElementById('l_password').value;
    if (!input || !pw) { showMsg('Please enter your username/email and password.','error'); return; }
    setBtn('loginBtn', true, 'Logging in...');
    try {
        let email = input;
        if (!input.includes('@')) {
            const aq = await getDocs(query(collection(db,'admins'), where('username','==',input.toLowerCase())));
            if (!aq.empty) { email = aq.docs[0].data().email; }
            else {
                const uq = await getDocs(query(collection(db,'users'), where('username','==',input.toLowerCase())));
                if (uq.empty) throw { code:'auth/user-not-found' };
                email = uq.docs[0].data().email;
            }
        }
        await setPersistence(auth, document.getElementById('rememberMe').checked ? browserLocalPersistence : browserSessionPersistence);
        await signInWithEmailAndPassword(auth, email, pw);
        RL.reset();
    } catch(e) {
        const n = RL.fail();
        if (n>=5) { startCountdown(); showMsg('Too many attempts. Try again in 15 minutes.','error'); }
        else { showMsg(`Invalid username or password! (${5-n} attempt${5-n!==1?'s':''} left)`,'error'); }
        setBtn('loginBtn', false, 'Login');
    }
};

window.doSignup = async () => {
    const name = document.getElementById('s_name').value.trim();
    const uname= document.getElementById('s_username').value.trim().toLowerCase();
    const email= document.getElementById('s_email').value.trim();
    const phone= document.getElementById('s_phone').value.trim();
    const pw   = document.getElementById('s_password').value;
    const conf = document.getElementById('s_confirm').value;
    if (!name||!uname||!email||!phone||!pw){ showMsg('All fields are required!','error'); return; }
    if (pw!==conf){ showMsg('Passwords do not match!','error'); return; }
    if (pw.length<8){ showMsg('Password must be at least 8 characters!','error'); return; }
    if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])/.test(pw)){ showMsg('Password needs uppercase, lowercase, number & special character!','error'); return; }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showMsg('Please enter a valid email address!','error'); return; }
    if (!/^\d{10}$/.test(phone.replace(/\D/g,''))){ showMsg('Please enter a valid 10-digit phone number!','error'); return; }
    setBtn('signupBtn', true, 'Creating account...');
    try {
        const uq = await getDocs(query(collection(db,'users'), where('username','==',uname)));
        if (!uq.empty){ showMsg('Username already taken!','error'); setBtn('signupBtn',false,'Create Account'); return; }
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        await updateProfile(cred.user, { displayName: name });
        await setDoc(doc(db,'users',cred.user.uid), {
            uid:cred.user.uid, fullName:name, username:uname, email,
            phone: phone.startsWith('+91')?phone:`+91${phone.replace(/\D/g,'')}`,
            photoUrl:null, provider:'email', dob:null, gender:null, emergencyContact:null,
            profileComplete:false, locationEnabled:false, address:null, role:'user',
            createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        });
        showMsg('Account created! Redirecting...','success');
    } catch(e) {
        showMsg(friendlyErr(e.code),'error');
        setBtn('signupBtn', false, 'Create Account');
    }
};

window.doGoogle = async () => {
    try {
        const r = await signInWithPopup(auth, new GoogleAuthProvider());
        const u = r.user;
        if (!(await getDoc(doc(db,'users',u.uid))).exists()) {
            const n = u.displayName||'user';
            await setDoc(doc(db,'users',u.uid), {
                uid:u.uid, fullName:n, username:n.toLowerCase().replace(/\s+/g,'_').slice(0,30),
                email:u.email||'', phone:u.phoneNumber||'', photoUrl:u.photoURL||null, provider:'google',
                dob:null,gender:null,emergencyContact:null,profileComplete:false,locationEnabled:false,
                address:null,role:'user',createdAt:serverTimestamp(),updatedAt:serverTimestamp()
            });
        }
    } catch(e) { showMsg(friendlyErr(e.code),'error'); }
};

window.doFacebook = async () => {
    try {
        const r = await signInWithPopup(auth, new FacebookAuthProvider());
        const u = r.user;
        if (!(await getDoc(doc(db,'users',u.uid))).exists()) {
            const n = u.displayName||'user';
            await setDoc(doc(db,'users',u.uid), {
                uid:u.uid, fullName:n, username:n.toLowerCase().replace(/\s+/g,'_').slice(0,30),
                email:u.email||'', phone:'', photoUrl:u.photoURL||null, provider:'facebook',
                dob:null,gender:null,emergencyContact:null,profileComplete:false,locationEnabled:false,
                address:null,role:'user',createdAt:serverTimestamp(),updatedAt:serverTimestamp()
            });
        }
    } catch(e) { showMsg(friendlyErr(e.code),'error'); }
};

window.handleForgot = async () => {
    const val = document.getElementById('l_username').value.trim();
    const addr = val.includes('@') ? val : prompt('Enter your email address to reset password:');
    if (!addr) return;
    try { await sendPasswordResetEmail(auth, addr); showMsg('Password reset email sent!','success'); }
    catch(e) { showMsg(friendlyErr(e.code),'error'); }
};

function friendlyErr(code) {
    return({
        'auth/invalid-email':'Invalid email address.',
        'auth/user-not-found':'Invalid username or password!',
        'auth/wrong-password':'Invalid username or password!',
        'auth/invalid-credential':'Invalid username or password!',
        'auth/email-already-in-use':'An account with this email already exists!',
        'auth/weak-password':'Password must be at least 6 characters.',
        'auth/too-many-requests':'Too many attempts. Try again in 15 minutes.',
        'auth/network-request-failed':'Network error. Check your connection.',
        'auth/popup-closed-by-user':'Sign-in popup was closed.'
    }[code]||'Something went wrong. Please try again.');
}
function setBtn(id,disabled,text){ const b=document.getElementById(id); if(b){b.disabled=disabled;b.textContent=text;} }
function showMsg(msg,type){
    const a=document.getElementById('msgArea'); if(!a) return;
    a.innerHTML=`<div class="php-message php-${type==='success'?'success':'error'}" id="_m">${msg}</div>`;
    clearTimeout(a._t);
    a._t=setTimeout(()=>{ const e=document.getElementById('_m'); if(e){e.classList.add('hide');setTimeout(()=>e.remove(),300);} },5000);
}
</script>

<script>
function switchTab(tab) {
    ['login','signup'].forEach(t=>{
        document.getElementById(t+'Tab').classList.toggle('active', t===tab);
        document.getElementById(t+'Form').classList.toggle('active', t===tab);
    });
    document.getElementById('msgArea').innerHTML='';
}

function togglePassword(id,btn) {
    const inp=document.getElementById(id), ic=btn.querySelector('i');
    if(inp.type==='password'){ inp.type='text'; ic.classList.replace('fa-eye','fa-eye-slash'); }
    else { inp.type='password'; ic.classList.replace('fa-eye-slash','fa-eye'); }
}

let _allReqsMet=false, _pwMatch=false;

function onPasswordInput(pw) {
    checkPasswordStrength(pw);
    checkPasswordMatch();
    updateSignupBtn();
    const show = pw.length>0;
    document.getElementById('passwordStrength').classList.toggle('show',show);
    document.getElementById('passwordRequirements').classList.toggle('show',show);
}

function checkPasswordStrength(pw) {
    const req = { len:pw.length>=8, up:/[A-Z]/.test(pw), lo:/[a-z]/.test(pw), num:/\d/.test(pw), sp:/[@$!%*?&]/.test(pw) };
    [['lengthReq',req.len],['uppercaseReq',req.up],['lowercaseReq',req.lo],['numberReq',req.num],['specialReq',req.sp]]
    .forEach(([id,v])=>{ const el=document.getElementById(id),ic=el.querySelector('.requirement-icon'); el.classList.toggle('valid',v); ic.textContent=v?'✓':'✗'; });
    const met=Object.values(req).filter(Boolean).length;
    _allReqsMet=(met===5);
    const fill=document.getElementById('strengthFill'), text=document.getElementById('strengthText');
    if(!pw.length){ fill.className='strength-fill'; text.textContent='Password strength'; return; }
    const lvl=met<=2?['weak','Weak']:met<=3?['fair','Fair']:met<=4?['good','Good']:['strong','Strong'];
    fill.className=`strength-fill ${lvl[0]}`; text.className=`strength-text ${lvl[0]}`; text.textContent=lvl[1];
}

function checkPasswordMatch() {
    const pw=document.getElementById('s_password').value, cf=document.getElementById('s_confirm').value;
    const ind=document.getElementById('passwordMatch');
    if(!cf.length){ ind.classList.remove('show'); _pwMatch=false; return; }
    const ok=pw===cf&&pw.length>0;
    ind.classList.add('show'); ind.classList.toggle('valid',ok); ind.classList.toggle('invalid',!ok);
    ind.textContent=ok?'✓':'✗'; _pwMatch=ok;
}

function updateSignupBtn() {
    const terms=document.getElementById('termsCheck').checked, can=_allReqsMet&&_pwMatch&&terms;
    const btn=document.getElementById('signupBtn');
    btn.disabled=!can; btn.style.opacity=can?'1':'0.6'; btn.style.cursor=can?'pointer':'not-allowed';
}

document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('s_phone').addEventListener('input',function(){
        this.value=this.value.replace(/\D/g,'');
        if(this.value.length>10) this.value=this.value.slice(0,10);
        this.style.borderColor=this.value.length===10?'#7cb342':(this.value.length?'#dc3545':'');
    });
    document.getElementById('s_username').addEventListener('input',function(){ this.value=this.value.replace(/[^a-zA-Z0-9_]/g,''); });
    document.getElementById('s_name').addEventListener('input',function(){ this.value=this.value.replace(/[^a-zA-Z\s]/g,''); });
    document.getElementById('s_email').addEventListener('blur',function(){
        const ok=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.value);
        this.style.borderColor=this.value?(ok?'#7cb342':'#dc3545'):'';
    });
    document.getElementById('l_password').addEventListener('keydown', e=>{ if(e.key==='Enter') window.doLogin(); });
    document.querySelectorAll('input[type="password"]').forEach(f=>{
        f.addEventListener('copy',e=>e.preventDefault());
        f.addEventListener('cut',e=>e.preventDefault());
        f.addEventListener('contextmenu',e=>e.preventDefault());
    });
    window.addEventListener('beforeunload',()=>{ document.querySelectorAll('input[type="password"]').forEach(f=>f.value=''); });
});
</script>

</body>
</html>